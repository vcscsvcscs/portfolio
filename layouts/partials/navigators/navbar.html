<!--- navigation bar at the top of page -->
{{/* Acquire sections data supporting both legacy wrapped map and new slice */}}
{{- $sectionsRaw := site.Data.sections -}}
{{- if (index site.Data site.Language.Lang).sections -}}
  {{- $sectionsRaw = (index site.Data site.Language.Lang).sections -}}
{{- end -}}
{{/* If it's a map with key sections, unwrap; if it's already a slice, keep */}}
{{- $sections := $sectionsRaw -}}
{{- if and (not (reflect.IsSlice $sectionsRaw)) (isset $sectionsRaw "sections") -}}
  {{- $sections = index $sectionsRaw "sections" -}}
{{- end -}}

{{- $customMenusEnabled := eq site.Params.navbar.customMenus.enable true -}}
{{- $customMenus := site.Params.navbar.customMenus.menus -}}

<nav class="navbar navbar-expand-lg navbar-light bg-light" id="navbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ .Site.Home.RelPermalink }}">
      {{ if .Site.Params.logo.main }}
        <img id="top-logo" class="lozad" data-src="{{ .Site.Params.logo.main }}" alt="{{ .Site.Title }}">
      {{ else }}
        {{ .Site.Title }}
      {{ end }}
    </a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbar-content"
      aria-controls="navbar-content"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbar-content">
      <ul class="navbar-nav ms-auto">
        {{- if $sections -}}
          {{- range $sections -}}
            {{- if and (.section.enable) (.section.showOnNavbar) -}}
              {{- $sectionID := replace (lower .section.name) " " "-"  -}}
              {{- if .section.id -}}
                {{- $sectionID = .section.id -}}
              {{- end -}}
              <li class="nav-item">
                <a class="nav-link smooth-scroll" href="{{ "" | absLangURL }}#{{ $sectionID }}">{{ .section.name }}</a>
              </li>
            {{- end -}}
          {{- end -}}
        {{- end -}}
        {{- if $customMenusEnabled -}}
          {{- range $customMenus -}}
            {{- if .showOnNavbar -}}
                <li class="nav-item">
                  <a class="nav-link" href="{{ .url }}">{{ .name }}</a>
                </li>
            {{- end -}}
          {{- end -}}
        {{- end -}}
        <!-- posts link -->
        {{ if not .Site.Params.navbar.hidePostsMenu }}
          <li class="nav-item">
            <a class="nav-link" href="{{ "/posts" | relLangURL }}">{{ i18n "posts" }}</a>
          </li>
        {{ end }}
        <!-- notes link -->
        {{ if not .Site.Params.navbar.hideNotesMenu }}
          <li class="nav-item">
            <a class="nav-link" href="{{ "/notes" | relLangURL }}">{{ i18n "notes" }}</a>
          </li>
        {{ end }}
        
        <!-- Custom menus that show on navbar -->
        {{- if $customMenusEnabled -}}
          {{- range $customMenus -}}
            {{- if .showOnNavbar -}}
                <li class="nav-item">
                  <a class="nav-link" href="{{ .url }}">{{ .name }}</a>
                </li>
            {{- end -}}
          {{- end -}}
        {{- end -}}

        <!-- multi-language -->
        {{ if and hugo.IsMultilingual (gt (len .Site.Languages) 2) }}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="languageSelector" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-globe-americas"></i> {{ .Site.Language.Params.languageName }}
            </a>
            <div class="dropdown-menu" aria-labelledby="languageSelector">
              {{ range .Site.Languages }}
                {{ if not (eq .Lang $.Site.Language.Lang) }}
                  <a class="dropdown-item" href="{{ .Lang | relLangURL }}">{{ .Params.languageName }}</a>
                {{ end }}
              {{ end }}
            </div>
          </li>
        {{ end }}

        {{ if and hugo.IsMultilingual (eq (len .Site.Languages) 2) }}
          {{ range .Site.Languages }}
            {{ if not (eq .Lang $.Site.Language.Lang) }}
              <li class="nav-item">
                <a class="nav-link" href="{{ .Lang | relLangURL }}">
                  <i class="fas fa-globe-americas"></i> {{ .Params.languageName }}
                </a>
              </li>
            {{ end }}
          {{ end }}
        {{ end }}

        <!-- theme toggle -->
        {{ if not .Site.Params.features.theme.disableToggle }}
          <li class="nav-item">
            <a
              class="nav-link theme-toggler icon-button"
              href="#"
              type="button"
              data-bs-toggle="tooltip"
              data-bs-placement="left"
              title="{{i18n "theme_toggle"}}"
              onclick="toggleTheme()"
            >
              <i id="theme-toggler-icon" class="fas fa-moon moon-icon"></i>
            </a>
          </li>
        {{ end }}
      </ul>
    </div>
  </div>
</nav>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var navbar = document.getElementById("navbar");
    var topLogo = document.getElementById("top-logo");

    // transparent navbar when in large screen
    if (window.innerWidth >= 992) {
      navbar.classList.add("navbar-dark", "transparent");
      if (topLogo != null) {
        if (navbar.classList.contains("transparent")) {
          topLogo.src = "{{ .Site.Params.logo.inverted | default .Site.Params.logo.main }}";
        }
      }
    }

    var didScroll;
    var lastScrollTop = 0;
    var delta = 5;
    var navbarHeight = navbar.offsetHeight;

    function hasScrolled() {
      var st = window.pageYOffset || document.documentElement.scrollTop;

      // Make sure they scroll more than delta
      if (Math.abs(lastScrollTop - st) <= delta) return;

      if (window.innerWidth >= 992) {
        // if they scrolled down and are past the navbar, add class .nav-up.
        // This is necessary so you never see what is "behind" the navbar.
        if (st > lastScrollTop && st > navbarHeight) {
          // Scroll Down
          navbar.classList.remove("nav-down");
          navbar.classList.add("nav-up");
        } else {
          // Scroll Up
          if (st + window.innerHeight < document.body.scrollHeight) {
            navbar.classList.remove("nav-up");
            navbar.classList.add("nav-down");
          }
        }

        // make navbar transparent when user scroll back to top in large screen
        if (st <= navbarHeight + 10) {
          navbar.classList.add("transparent");
          // change the logo
          if (topLogo != null) {
            topLogo.src = "{{ .Site.Params.logo.inverted | default .Site.Params.logo.main }}";
          }
        } else {
          navbar.classList.remove("transparent");
          // change the logo
          if (topLogo != null) {
            topLogo.src = "{{ .Site.Params.logo.main }}";
          }
        }
      }
      lastScrollTop = st;
    }

    window.addEventListener("scroll", function (event) {
      didScroll = true;
    });

    setInterval(function () {
      if (didScroll) {
        hasScrolled();
        didScroll = false;
      }
    }, 250);
  });
</script>
